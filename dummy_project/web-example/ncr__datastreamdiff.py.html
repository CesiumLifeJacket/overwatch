<!doctype html>
<html>
<head>
	<link rel="stylesheet" href="css/styles/arduino-light.css">
	<link rel="stylesheet" href="css/file.css">
	<script src="js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
<h1><a href=Index.html>/</a><a href=ncr.html>ncr/</a>datastreamdiff.py</h1>

<pre><code class="python">
'''Datastream comparison classes for the ncreview tool.

This module contains the classes nessecary to perform a comparison of t<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>wo 
datastreams and output the resulting comparison report to a json file wh<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>ich 
can be rendered by the web tool.

Recurring Attributes

A name attribute is the name of the object's corresponding section in the
    web-based UI.

A dsd attribute refers back to the DatastreamDiff that contains the object.

Recurring methods:

Generally, a class's initializer generates the comparison<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div> data structure 
    from params old and new as the data structures to be compared.
    These old and new params' type generally indicated by the class name,
    for example DatastreamDiff compares two Datastreams,
    TimelineDiff compares two Timelines.
    the dsd parameter should take in the parent DatastreamDiff.

A difference() method returns 'same', 'changed', 'added', or 'removed'
    indicating the nature of that comparison object. T<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>hese difference strings 
    are used later in the web tool to highlight entries accordingly.

A jsonify() method returns a data structure that can be converted to json
    and used to generate the report in the web-based UI.

'''

import os
import sys
import json
<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>from collections import namedtuple 

from ncr.datastream import TimedData, UntimedDat<div class="violation" type="E266" title="too many leading '#' for block comment" style="width:1ch;"></div>a
import ncr.utils as utils
import pdb

### Timeline --------------------------<div class="violation" type="E501" title="line too long (119 &gt; 79 characters)" style="width:1ch;"></div>--------------------------------------------------------------------------------

Diff = namedt<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>uple('Diff', ['old', 'new', 'beg', 'end'])

class TimelineDiff(list):
    '''Comparison between two Timelines.
    Logs the differences between two timelines in a list of Diff objects.
    '''
    def __init__(self, name, old, new, dsd):
        super(TimelineDiff, self).__init__(self)
        self.name = name
        self.dsd = dsd

        for beg, end, old_<div class="violation" type="E501" title="line too long (97 &gt; 79 characters)" style="width:1ch;"></div>i, new_i in utils.shared_times(dsd.old_file_times, dsd.new_file_times):
            old_val = nex<div class="violation" type="E501" title="line too long (81 &gt; 79 characters)" style="width:1ch;"></div>t((l.val for l in old if l.beg &lt;= old_i &lt;= l.end), None)
            new_val = ne<div class="violation" type="E501" title="line too long (81 &gt; 79 characters)" style="width:1ch;"></div>xt((l.val for l in new if l.beg &lt;= new_i &lt;= l.end), None)

            if self and self[-1].old == old_val and self[-1].new == new_val:
                self[-1] = Diff(self[-1].old, self[-1].new, self[-1].beg, end)
            else:
                self.append(Diff(old_val, new_val, beg, end))

    @utils<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>.store_difference
    def differen<div class="violation" type="E731" title="do not assign a lambda expression, use a def" style="width:1ch;"></div>ce(self):
        if not self: <div class="violation" type="E127" title="continuation line over-indented for visual indent" style="width:1ch;"></div>
     <div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>       return 'same'

        diff = lambda d: \<div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>
             'same'    if d.old == d.new else \
             'added'   if d.old is None else \
             'removed' if d.new is None else \
             'changed'

        first = diff(self[0])

        if first == 'changed' or all(diff(d) == first for d in self):
            return first
        else:
            return 'changed'

    def jsonify(self):
        if len(self) == 1:
            sec = {
                'type': 'staticValueDiff',
                'name': self.name,
                'old': self[0].old,
                'new': self[0].new
            }
            if hasattr(self, '_difference'):
                sec['difference'] = self._difference
            return sec
        else:
            return utils.json_section(self, [
                {
                    'type': <div class="violation" type="E501" title="line too long (103 &gt; 79 characters)" style="width:1ch;"></div>'timelineDiff',
                    'data': [['old', 'n<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>ew', 'beg', 'end']]+[[d.old, d.new, d.beg, d.end] for d in self]
                }
            ])

def compare_timelines(name, old, new, dsd):
    td = TimelineDiff(name, old, new, dsd)
    if td.difference() == 'same':
        setattr(new, '<div class="violation" type="E266" title="too many leading '#' for block comment" style="width:1ch;"></div>_difference', 'same')
        setattr(new, 'difference', lambda: 'same')
      <div class="violation" type="E501" title="line too long (119 &gt; 79 characters)" style="width:1ch;"></div>  return new
    return td

### Data ----------------------------------------------------------------------------------<div class="violation" type="E501" title="line too long (86 &gt; 79 characters)" style="width:1ch;"></div>----------------------------

# TODO: Create a new kind of object TimedDataDelta which<div class="violation" type="E501" title="line too long (83 &gt; 79 characters)" style="width:1ch;"></div> will plot new minus old data.
# TODO: Yan wants a feature where differences betwee<div class="violation" type="E501" title="line too long (96 &gt; 79 characters)" style="width:1ch;"></div>n individual valu<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>es are plotted
# TODO: somebody else wants a feature where a density of scatterpoints of old and new is plotted

class TimedDataDiff:
    '''Comparison of old and new timed data.
    '''
    def __init__(self, old, new, dsd):
        self.var_name = old.var_name
        self.dsd = dsd
        self.name = 'Dat<div class="violation" type="E501" title="line too long (86 &gt; 79 characters)" style="width:1ch;"></div>a'
        self.data_type = new.data_type
        self.old = [old.data[t] if t in old.<div class="violation" type="E501" title="line too long (86 &gt; 79 characters)" style="width:1ch;"></div>data else None for t in dsd.summary_times]
        self.new = [new.data[t] if t in new.data else None for t in dsd.summary_times]

  <div class="violation" type="E731" title="do not assign a lambda expression, use a def" style="width:1ch;"></div>  @utils.store_difference
    def diffe<div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>rence(self):
        if not self.old an<div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>d not self.new:
            return 'same'

        diff = lambda o, n: \
           <div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div> 'same'    if o == n else \
            'added'   if o is None else \
            'removed' if n is None else \
            'changed'
        
        summary_times = self.dsd.summary<div class="violation" type="E501" title="line too long (97 &gt; 79 characters)" style="width:1ch;"></div>_times
        sample_interval = self.dsd.sample_interval

        shared_times = list(utils.shared_times(self.dsd.old_file_times, self.dsd.new_file_times))

        # get the first difference
        def sample_diffs():
            i = 0
            for beg, end, *_ in s<div class="violation" type="E701" title="multiple statements on one line (colon)" style="width:1ch;"></div>hared_times:
                beg = (beg//sample_interval)*sample_interval

                while i &lt; len(summary_times) and summary_times[i] &lt; beg: i += 1

                while i &lt; len(summary_times) and summary_times[i] &lt;= end:
                    yield diff(self.old[i], self.new[i])
                    i += 1

        sample_diffs = sample_diffs()

        first = next(sample_diffs, 'same')

        # if the first one is changed, we don't need to check any more
        if first == 'changed':
            return first

        # check the remaining differences
        for d in sample_diffs:
            if d != first:
                return 'changed'

        return first

    def jsonify(self):

        columns, tooltips = self.data_type.columns()

        if len(self.dsd.summary_times) == 1:
            sec = None
            if self.old[0] != self.new[0]:
                sec = {
                <div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>    'type': 'staticSummaryDiff',
             <div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>       'name': self.name,
                    'columns': columns,
                    'tooltips': tooltips,
                    'old' : self.old[0].row(),
                    'new' : s<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>elf.new[0].row()
                }
            else:
                sec = {
                    'type': 'staticSummary',
                    'name'<div class="violation" type="E703" title="statement ends with a semicolon" style="width:1ch;"></div>: self.name,
          <div class="violation" type="E231" title="missing whitespace after ','" style="width:1ch;"></div>          'va<div class="violation" type="E703" title="statement ends with a semicolon" style="width:1ch;"></div>l' : self.new[0].row()
                }

        <div class="violation" type="E122" title="continuation line missing indentation or outdented" style="width:1ch;"></div>    sec['difference'] = self.difference()
            return sec

        column<div class="violation" type="E501" title="line too long (80 &gt; 79 characters)" style="width:1ch;"></div><div class="violation" type="E502" title="the backslash is redundant between brackets" style="width:1ch;"></div>s = ['beg', 'end']+columns;
        tooltips = ['','']+tooltips;
        old_csv = [columns, tooltips] + \
        [
   <div class="violation" type="E122" title="continuation line missing indentation or outdented" style="width:1ch;"></div>         [t, t+self.dsd.sample_interval]+(x.row() if x is not None else []) \
 <div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>           for t, x in zip(self.dsd.summary_times, self.old)
        ]
 <div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>       new_csv = [columns, tooltips] + \
        [
            [t, t+self.dsd.sample_interval]+(x.row() if x is not None else [])  
            for t, x in<div class="violation" type="E701" title="multiple statements on one line (colon)" style="width:1ch;"></div> zip(self.dsd.summary_times, self.new)
        ]
        
        # add nones to complete any empty rows
        for csv in old_csv, new_csv:
            length = max(map(len, csv))
            if length == 2: continue
            for row in csv:
                if len(row) == 2:
                    row += [None]*(length-2)

        plotDiff_json = {
                'type': 'plotDiff',
                'old_data': old_csv,
                'new_data': new_csv,
                'old_ds_path': self.ds<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>d.old_path,
                'new_ds_path': self.dsd.new_path
           }

        if self.dsd.use_dq_inspector:
            plotDiff_json['var_name'] = self.var_name

        return utils.json_section(self, [plotDiff_json]<div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>)

class UntimedDataDiff(TimelineDiff):
    '''Comparison of old and new untimed data.
    '''
    def __init__(self, old, new, dsd):
        TimelineDiff.__init__(self, 'Data', old, new, dsd)
        self.data_type = new.data_type
    
    def jsonify(self):
        columns, tooltips = self.data_type.columns()

        if len(self) == 1:
            sec = None
            if sel<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>f[0].old != self[0].new:
                sec =<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div> {
                    'type': 'staticSummaryDiff',
                    'name': self.name,
                    'columns': columns,
                    'tooltips': tooltips,
                    'old' : self[0].old.row(),
                    'new' : self[0].new.row(<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>)
                }
            else:
                sec = {
                    'type': 'staticSummary',
 <div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>                   'name': self.name,
                    'columns': c<div class="violation" type="E231" title="missing whitespace after ','" style="width:1ch;"></div>olumns,
     <div class="violation" type="E703" title="statement ends with a semicolon" style="width:1ch;"></div>               'tooltips': tooltips,
                    'val' : self[0].new.row<div class="violation" type="E501" title="line too long (111 &gt; 79 characters)" style="width:1ch;"></div>()
                }

            sec['difference'] = self.difference()
            return sec
        
       <div class="violation" type="E501" title="line too long (111 &gt; 79 characters)" style="width:1ch;"></div> columns = ['beg', 'end']+columns
        tooltips = ['','']+tooltips;
        old_csv = [columns, tooltips]+[[d.beg, d.end]+(d.old.row() if d.old is not None else []) for d in se<div class="violation" type="E701" title="multiple statements on one line (colon)" style="width:1ch;"></div>lf]
        new_csv = [columns, tooltips]+[[d.beg, d.end]+(d.new.row() if d.new is not None else []) for d in self]

        # add nones to complete any empty rows
        for csv in old_csv, new_csv:
            length = max(map(len, csv))
            if length == 2: continue
            for row in csv:
                if len(row) == 2:
           <div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>         row += [None]*(length-2)

        return utils.json_section(self, [
            {
                'type': 'plotDiff',
                'data_type': self.data_type.type_name,
                'old_data': old_csv,
                'new_data': new_csv
            }
        ])

def compare_data(old, new, dsd):
    '''Generic data comparison function.
    '''
    if type(old) != type(<div class="violation" type="E266" title="too many leading '#' for block comment" style="width:1ch;"></div>new) or type(old.data_type) != type(new.data_type):
        raise ValueError('c<div class="violation" type="E501" title="line too long (119 &gt; 79 characters)" style="width:1ch;"></div>annot compare data summaries of differen<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>t type')
    if isinstance(old, TimedData):
        return TimedDataDiff(old, new, dsd)

    if isinstance(old, UntimedData):
        return UntimedDataDiff(old, new, dsd)

### Variable ----------------------------------------------------------------------------------------------------------

class VariableDiff:
    '''Comparison of old and new variables.

    Attribtues:
        name        Variable name
        dims        TimelineDiff of variables' dimensions
        dtype       TimelineD<div class="violation" type="E501" title="line too long (88 &gt; 79 characters)" style="width:1ch;"></div>iff of vareiables' data types
        attributes  TimelineDictDiff of the variables' att<div class="violation" type="E501" title="line too long (88 &gt; 79 characters)" style="width:1ch;"></div>ributes
        companions  VariableDictDiff of the variables' companion variables
        data        Comparison of the variables' data
        old_data    if the old and new data types are incomparable, this stores old data
        new_data    if the old and new data types are incomparable, this stores new data
  <div class="violation" type="E501" title="line too long (93 &gt; 79 characters)" style="width:1ch;"></div>  '''
    def __init__(self, name, old, new, dsd):
        self.name = name
        self.dims<div class="violation" type="E501" title="line too long (93 &gt; 79 characters)" style="width:1ch;"></div> = compare_timelines('Dimensions', old.dims, new.dims, dsd)
        self.dtype = compare_timelines('Data Type', old.dtype, new.dtype, dsd)
        self.attributes = TimelineDictDiff('Attributes', old.attributes, new.attributes, dsd)
        self.companions = VariableDictDiff('Companions', old.companions, new.companions, dsd)
        self.data = None
        self.old_data = None
        self.new_data = None
        if not old.metadata_only or not new.metadata_only:
            try:
                self.data = compare_data(old.data, new.data, dsd)<div class="violation" type="E501" title="line too long (117 &gt; 79 characters)" style="width:1ch;"></div>
            except ValueError as e:
                # create data to display error later
                dsd.has_warnings = True
                if not hasattr(dsd, 'incomparable_summaries'):
                    dsd.incomparable_summaries = []
                dsd.incomparable_summaries.append((name, old.data.data_type.type_name, new.data.data_type.type_name))

                self.old_data = old.data
                self.old_data.name = 'Old Data'
                self.new_data = new.data
                self.new_data.name = 'New Data'

    @utils.store_difference
    def differenc<div class="violation" type="E111" title="indentation is not a multiple of four" style="width:1ch;"></div>e(self):
        first = self.dims.difference()

        if first == 'changed' or not self.data:
            return 'changed'

        if first == self.dtype.difference() and \
           first == self.attri<div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>butes.difference() and \
           first == self.companions.difference() and \
           first == self.data.difference():
           return first
        else:
            return 'changed'

    def jsonify(self):
        contents = [
            self.dtype.jsonify(),
            self.dims.jsonify(),
            self.attributes.jsonify(),
        ]
        
        if self.data:
            contents.append(self.data.jsonify())
        elif self.old_data and self.new_data:
            contents += self.old_data.jsonify(), self.new_data.jsonify()

        sec = utils.json_section(self, contents)

        if self.companions:
            sec['contents'].append(self.companions.jsonify())

 <div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>       sec['type'] = 'variableDiff'
        if len(sel<div class="violation" type="E266" title="too many leading '#' for block comment" style="width:1ch;"></div>f.dims) == 1:
            if isinstance(self.dims, TimelineDiff):
             <div class="violation" type="E501" title="line too long (119 &gt; 79 characters)" style="width:1ch;"></div>   if self.dims[0].old == self.dims[0].n<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>ew:
                    sec['dims'] = self.dims[0].new
                else:
                    sec['<div class="violation" type="E501" title="line too long (89 &gt; 79 characters)" style="width:1ch;"></div>dims'] = 'varying'
            else:
                sec['dims'] = self.dims[0].val
        else: 
            sec['dims'] = 'varying'
        retur<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>n sec

### Dicts ---------<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>-------------------------------------<div class="violation" type="E227" title="missing whitespace around bitwise or shift operator" style="width:1ch;"></div>---------------------------------------------------------------

class NCDictDiff(dict):
    '''Extention of the dictionary story nc objects, either attributes or variable summaries.
    '''
    def __init__(self, name, old, new, dsd, constructor):
        super(NCDictDiff, self).__init__(self)
        self.name = name    
        self.dsd = dsd  
        for name in set(old.keys())|set(new.keys()):
            if name in old and name in new:
           <div class="violation" type="E701" title="multiple statements on one line (colon)" style="width:1ch;"></div>     self[name] = const<div class="violation" type="E731" title="do not assign a lambda expression, use a def" style="width:1ch;"></div>ructor(name, old[name], n<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>ew[name], dsd)
            elif name in old:
                self[name] = old[name]
      <div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>          setattr(self[name], '_difference', 'removed')
            elif name in new:
                self[name]<div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div> = new[name]
                setattr(self[name], '_difference', 'added')

    @utils.store_dif<div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>ference
    def difference(self):
        if not self: return 'same'

        get_difference =<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div> lambda x : \
            <div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>x.difference() if hasattr(<div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>x, 'difference') else \
  <div class="violation" type="E203" title="whitespace before ':'" style="width:1ch;"></div>          x._<div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>difference  if hasattr(x, '_difference') else \
            'same'

        first = get_difference(next(iter(self.values())))
    
        if all(get_<div class="violation" type="E272" title="multiple spaces before keyword" style="width:1ch;"></div>difference(d) == first for d in self.values()):
            return first
        
        return 'changed'

    def jsonify(self):

        n_diffs = {
            'same'    : 0,
            'changed' : 0,
            'added'   : 0,
            'removed' : 0
        }           

        for val in self.values():
            diff = val.difference() if hasattr(val, 'difference') else \
                 <div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>  val._difference  if hasattr(val, '_difference') else \
                   'same'

            n_diffs[diff] += 1

        sec = utils.json_sectio<div class="violation" type="W293" title="blank line contains whitespace" style="width:1ch;"></div>n(self, <div class="violation" type="E266" title="too many leading '#' for block comment" style="width:1ch;"></div>[t.jsonify() for t in self.values()])
        sec['type'] = 'groupDiff'
       <div class="violation" type="E501" title="line too long (119 &gt; 79 characters)" style="width:1ch;"></div> sec['n_diffs'] = n_diffs
        return<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div> sec


class TimelineDictDiff(NCDictDiff):
    def __init__(self, name, old, new, dsd):
        NCDictDiff.__init__(self, name, old, new, dsd, compare_timelines)

class VariableDictDiff(<div class="violation" type="E501" title="line too long (97 &gt; 79 characters)" style="width:1ch;"></div>NCDictDiff):
    def __init__(self, name, old, new, dsd):
        NCDictDiff.__init__(self, name, old, new, dsd, VariableDiff)
        
### Datastream --------------------------------------------------------------------------------------------------------

def f<div class="violation" type="E302" title="expected 2 blank lines, found 1" style="width:1ch;"></div>time_difference(old_ftimes, new_ftimes):
    '''Compare two file timelines and return their difference.

    This is separated out into a function purely to keep DatastreamDiff's jsonify() looking tidy.
    '''
    if old_ftimes and not <div class="violation" type="E501" title="line too long (91 &gt; 79 characters)" style="width:1ch;"></div>new_ftimes:
        return 'removed'
    elif new_ftimes and not old_ftimes:
        return 'added'
    elif all(a == b for a, b in zip(old_ftimes, new_ftimes)):
        return 'same'
    else:
        return 'changed'

class DatastreamDiff:
 <div class="violation" type="E227" title="missing whitespace around bitwise or shift operator" style="width:1ch;"></div>   def __init__(self,<div class="violation" type="E501" title="line too long (82 &gt; 79 characters)" style="width:1ch;"></div> old, new):
        self.sample_interval = old.sample_interval

        if old.sample_interval != new.sample_interval:
            raise ValueError('Old and new datastreams mus<div class="violation" type="E501" title="line too long (94 &gt; 79 characters)" style="width:1ch;"></div>t share the same sample interval')
        self.has_warnings = False
        self.old_path = o<div class="violation" type="E501" title="line too long (94 &gt; 79 characters)" style="width:1ch;"></div>ld.path
        self.new_path = new.path
        self.old_ds_name = old.ds_name
        self.n<div class="violation" type="E501" title="line too long (90 &gt; 79 characters)" style="width:1ch;"></div>ew_ds_name = new.ds_name
        self.summary_times = sorted(set(old.summary_times)|set(new.summary_times))
        self.old_file_times = old.file_timeline
        self.new_file_times = new.file_timeline
        self.attributes = TimelineDictDiff('Att<div class="violation" type="E501" title="line too long (109 &gt; 79 characters)" style="width:1ch;"></div>ributes', old.attributes, n<div class="violation" type="E225" title="missing whitespace around operator" style="width:1ch;"></div>ew<div class="violation" type="E502" title="the backslash is redundant between brackets" style="width:1ch;"></div>.attributes, self)
  <div class="violation" type="E128" title="continuation line under-indented for visual indent" style="width:1ch;"></div>      self.dimensions = TimelineDictDiff('Dimensions', old.dimensions, new.dimensions, self)
        self.variables = V<div class="violation" type="E228" title="missing whitespace around modulo operator" style="width:1ch;"></div>ariableDictDi<div class="violation" type="E501" title="line too long (107 &gt; 79 characters)" style="width:1ch;"></div>ff('Variables', old.variables, new.variables, self)
        self.use_dq_inspector = old.use_dq_inspector and new.use_dq_inspector

        if self.has_warnings:
            if hasattr(self, 'incomparable_summaries'):
                sys.stderr.write('\n%d variable summaries are of different type and cannot be compared:\n'% \
                    len(self.incomparable_summaries)
                    )
                sys.stderr.write('\n'.join('%s - Old: %s, New: %s'%x for x <div class="violation" type="W291" title="trailing whitespace" style="width:1ch;"></div>in self.incomparable_summaries))
                sys.stderr.write('\n')
            sys.stderr.flush()

    def jsonify(self):
        return {
            'type':<div class="violation" type="E501" title="line too long (93 &gt; 79 characters)" style="width:1ch;"></div> 'datastreamDiff',
            'old_path': self.old_path,
            'new_path': self.new_path,
            'old_ds_name': self.old_ds_name,
            'new_ds_name': self.new_ds_name,
            'sample_interval': self.sample_interval,
            'summary_times': self.summary_times,
            'contents': [
                {  
                    'type': 'section',
                    'name': 'File Timeline',
                    'difference': ftime_difference(self.old_file_times, self.new_file_times),
                    'contents': [
                        {
                            'type': 'fileTimelineDiff',
                            'old_data': [['beg', 'end']]+self.old_file_times,
                            'new_data': [['beg', 'end']]+self.new_file_times
                        }
                    ]
                },
                self.attributes.jsonify(),
                self.dimensions.jsonify(),
                self.variables.jsonify()
            ]
        }

    def json(self):
        j = self.jsonify()
        return json.dumps(j, default=utils.JEncoder)

</code></pre>
</body>
</html>